[SERVER]
11.11.11.11

[DOWNLOAD]
NCL/6.6.2 https://download-ib01.fedoraproject.org/pub/epel/8/Everything/SRPMS/Packages/n/ncl-6.6.2-12.el8.src.rpm


[DEPENDENCY]
set -e
set -x
module purge
./jarvis -install bisheng/2.3.0 com
module use ./software/modulefiles
module load bisheng/2.3.0
cd /etc/yum.repos.d/
mkdir backup
cp *.repo backup/
sed -i -e 's|$releasever|8-stream|g' /etc/yum.repos.d/CentOS-*
sed -i '15 s/^/#/' /etc/yum.repos.d/CentOS-AppStream.repo
sed -i '16 s/^#//' /etc/yum.repos.d/CentOS-AppStream.repo
sed -i '15 s/^/#/' /etc/yum.repos.d/CentOS-Base.repo
sed -i '16 s/^#//' /etc/yum.repos.d/CentOS-Base.repo
sed -i '16 s/^/#/' /etc/yum.repos.d/CentOS-centosplus.repo
sed -i '17 s/^#//' /etc/yum.repos.d/CentOS-centosplus.repo
sed -i '19 s/^/#/' /etc/yum.repos.d/CentOS-CR.repo
sed -i '20 s/^#//' /etc/yum.repos.d/CentOS-CR.repo
sed -i '15 s/^/#/' /etc/yum.repos.d/CentOS-Devel.repo
sed -i '16 s/^#//' /etc/yum.repos.d/CentOS-Devel.repo
sed -i '16 s/^/#/' /etc/yum.repos.d/CentOS-Extras.repo
sed -i '17 s/^#//' /etc/yum.repos.d/CentOS-Extras.repo
sed -i '5 s/^/#/' /etc/yum.repos.d/CentOS-fasttrack.repo
sed -i '6 s/^#//' /etc/yum.repos.d/CentOS-fasttrack.repo
sed -i '15 s/^/#/' /etc/yum.repos.d/CentOS-HA.repo
sed -i '16 s/^#//' /etc/yum.repos.d/CentOS-HA.repo
sed -i '15 s/^/#/' /etc/yum.repos.d/CentOS-PowerTools.repo
sed -i '16 s/^#//' /etc/yum.repos.d/CentOS-PowerTools.repo
sed -i '18c enabled=1' /etc/yum.repos.d/CentOS-PowerTools.repo

yum install -y epel-release

yum clean all && yum makecache
yum install -y zlib zlib-devel rpm rpm-build rpmdevtools gzip expat expat-devel byacc cairo-devel tcsh gsl-devel imake libXaw-devel libjpeg-devel openblas-devel g2clib-static gdal-devel hdf-devel hdf-static netcdf-fortran-devel proj-devel udunits2-devel flex gcc-c++ make 

[ENV]
module purge

export CPPFLAGS=" -g -fsigned-char "$CPPFLAGS
export CFLAGS=" -g -fsigned-char "$CFLAGS
export CXXFLAGS=" -g -fsigned-char "$CXXFLAGS


[APP]
app_name = NCL
build_dir = ${JARVIS_TMP}/ncl_6.6.2
binary_dir = ${JARVIS_LIBS}/bisheng2.3.0/ncl/usr/bin
case_dir = ${JARVIS_LIBS}/bisheng2.3.0/ncl/usr/bin

[BUILD]
cd ${JARVIS_TMP}
rm -rf ncl_6.6.2
mkdir ncl_6.6.2
cd ncl_6.6.2

rpm2cpio ${JARVIS_DOWNLOAD}/ncl-6.6.2-12.el8.src.rpm | cpio -div

sed -i "20a +        case    aarch64:" ncl-5.1.0-ppc64.patch
sed -i '21a +            set model   = $mach' ncl-5.1.0-ppc64.patch
sed -i '22a +            set arch    = $mach' ncl-5.1.0-ppc64.patch
sed -i "23a +            set sysincs = LINUX" ncl-5.1.0-ppc64.patch
sed -i "24a +            set vendor  = ARM" ncl-5.1.0-ppc64.patch
sed -i "25a +            breaksw" ncl-5.1.0-ppc64.patch
sed -i '3c @@ -372,19 +372,19 @@' ncl-5.1.0-ppc64.patch

sed -i "9,10d"	ncl-5.2.1-secondary.patch
sed -i '3c @@ -373,6 +373,8 @@' ncl-5.2.1-secondary.patch

cat << EOF > ~/.rpmmacros
$a%_topdir %(echo $PWD)
EOF

mkdir -p $PWD/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
cp ncl-6.6.2.tar.gz SOURCES/
cd SOURCES/
tar -zxvf ncl-6.6.2.tar.gz
sed -i '61c EXCSRCS = bcopyswap.c logic32.c' ncl-6.6.2/common/src/libncarg_c/yMakefile
sed -i '62c EXFSRCS = gbytes.f sbytes.f' ncl-6.6.2/common/src/libncarg_c/yMakefile
sed -i '62a EXOBJS  = bcopyswap.o sbytes.o gbytes.o logic32.o' ncl-6.6.2/common/src/libncarg_c/yMakefile

sed -i '32c #define LibSearchUser    -L/usr/X11R6/lib64 -L/usr/lib64' ncl-6.6.2/config/LINUX
sed -i '33c #define IncSearchUser    -I/usr/X11R6/include -I/usr/include' ncl-6.6.2/config/LINUX
sed -i '35c #define ArchRecLibSearch    -L/usr/X11R6/lib64 -L/usr/lib64' ncl-6.6.2/config/LINUX
sed -i '36c #define ArchRecIncSearch    -I/usr/X11R6/include -I/usr/include' ncl-6.6.2/config/LINUX

sed -i "9660c IF ((CEX1(1:1).EQ.' ') .AND. (LCX1 .EQ. 1)) LCX1=0" ncl-6.6.2/ncarg2d/src/libncarg/conpack/CodeIftran
sed -i "9662c IF ((CEX2(1:1).EQ.' ') .AND. (LCX2 .EQ. 1)) LCX2=0" ncl-6.6.2/ncarg2d/src/libncarg/conpack/CodeIftran
sed -i "9664c IF ((CEX3(1:1).EQ.' ') .AND. (LCX3 .EQ. 1)) LCX3=0" ncl-6.6.2/ncarg2d/src/libncarg/conpack/CodeIftran
sed -i "9791c CBUF(1:1)='0'" ncl-6.6.2/ncarg2d/src/libncarg/conpack/CodeIftran

sed -i '46c EXTRA_CCOPTIONS = -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -g -fsigned-char' ncl-6.6.2/ni/src/ncl/yMakefile

rm -rf ncl-6.6.2.tar.gz
tar -zcvf ncl-6.6.2.tar.gz ncl-6.6.2
rm -rf ncl-6.6.2
cd ..

cp *.patch SOURCES/
cp Site.local.ncl SOURCES/
cp ncarg.csh SOURCES/
cp ncarg.sh SOURCES/
cp ncl.spec SPECS/
cd SPECS/
rpmbuild -ba ncl.spec
cd ..


rpm2cpio  ${JARVIS_TMP}/ncl_6.6.2/RPMS/aarch64/ncl-6.6.2-12.el8.aarch64.rpm | cpio -div
rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/aarch64/ncl-debuginfo-6.6.2-12.el8.aarch64.rpm |cpio -div
rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/aarch64/ncl-debugsource-6.6.2-12.el8.aarch64.rpm | cpio -div
rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/aarch64/ncl-devel-6.6.2-12.el8.aarch64.rpm | cpio -div
rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/aarch64/ncl-devel-debuginfo-6.6.2-12.el8.aarch64.rpm | cpio -div

rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/noarch/ncl-common-6.6.2-12.el8.noarch.rpm | cpio -div
rpm2cpio ${JARVIS_TMP}/ncl_6.6.2/RPMS/noarch/ncl-examples-6.6.2-12.el8.noarch.rpm | cpio -div


cp -r usr ${JARVIS_LIBS}/bisheng2.3.0/ncl
export PATH=$PATH:${JARVIS_LIBS}/bisheng2.3.0/ncl/usr/bin
export NCARG_ROOT=${binary_dir}

[RUN]
run =  export PATH=$PATH:${JARVIS_LIBS}/bisheng2.3.0/ncl/usr/bin && export NCARG_ROOT=${JARVIS_LIBS}/bisheng2.3.0/ncl/usr && export NCARG_COLORMAPS=$NCARG_ROOT/lib64/ncarg/colormaps && ncl -Q
binary = 
nodes = 1
